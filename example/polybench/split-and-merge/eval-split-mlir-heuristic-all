#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd)"
TMPDIR="${DIR}/tmp"
mkdir -p "${TMPDIR}"

TIMESTAMP="$(date "+%Y%m%d-%H%M%S")"

TEST_CASE="$1"
BASEDIR="$(basename "${TEST_CASE}")"
WORKDIR="${TMPDIR}/heuristic.${BASEDIR}.${TIMESTAMP}"
WORKLOG="${TMPDIR}/heuristic.${BASEDIR}.${TIMESTAMP}.log"

mkdir -p "${WORKDIR}"
cp -r "${TEST_CASE}"/* "${WORKDIR}"

for d in "${WORKDIR}"/*/; do
  BASENAME=$(basename "$d")
  TARGET="$d/$BASENAME.c"

  "${DIR}/eval-split-mlir-heuristic" "$TARGET" >> "${WORKLOG}"
done
